<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס הרשמה - IDEAL TOURS</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #f8f9fa;
            --accent-color: #ffc107;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: #e9ecef;
            color: #333;
        }

        .paper-container {
            background: #fff;
            max-width: 1000px;
            margin: 30px auto;
            padding: 40px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            border-top: 6px solid var(--primary-color);
            border-radius: 8px;
        }

        
        .contact-highlight {
            background-color: var(--accent-color);
            padding: 6px 12px;
            font-weight: 600;
            display: inline-block;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* Section Titles */
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-top: 35px;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .section-title i {
            margin-left: 8px;
        }

        /* Table */
        .table th {
            background-color: #f1f3f5;
            font-size: 0.85rem;
            vertical-align: middle;
            text-align: center;
        }
        
        .table td {
            vertical-align: middle;
            padding: 8px;
        }

        .form-control, .form-select {
            font-size: 0.9rem;
            border-radius: 4px;
        }

        /* Passenger Card Styles */
        .passenger-card {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }

        .passenger-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .passenger-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            background: #e3f2fd;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .passenger-fields {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .passenger-field {
            display: flex;
            flex-direction: column;
        }

        .passenger-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .passenger-field .form-control,
        .passenger-field .form-select {
            font-size: 1rem;
            padding: 10px 12px;
            min-height: 44px;
        }

        .passenger-field.checkbox-field {
            flex-direction: row;
            align-items: center;
            gap: 8px;
            padding-top: 25px;
        }

        .passenger-field.checkbox-field label {
            margin-bottom: 0;
        }

        .passenger-field.checkbox-field .form-check-input {
            width: 20px;
            height: 20px;
        }

        .freq-flyer-wrapper {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .freq-flyer-wrapper .freq-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 992px) {
            .passenger-fields {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .passenger-fields {
                grid-template-columns: 1fr;
            }
            
            .passenger-card {
                padding: 15px;
            }
        }

        .btn-remove {
            border: none;
            background: transparent;
            color: #dc3545;
            transition: 0.2s;
        }
        
        .btn-remove:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #b0c4de;
            background-color: #f8fbff;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: var(--primary-color);
        }
        
        .file-list-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            margin-top: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        /* Bottom Text */
        .terms-box {
            background-color: #fdfdfe;
            border: 1px solid #dee2e6;
            padding: 20px;
            font-size: 0.75rem;
            line-height: 1.5;
            color: #555;
            text-align: justify;
            margin-top: 20px;
        }
        
        .terms-box h6 {
            color: #000;
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 4px;
            margin-top: 10px;
            text-decoration: underline;
        }

        .signature-input {
            border: none;
            border-bottom: 2px solid #333;
            border-radius: 0;
            background: transparent;
            font-family: 'Rubik', cursive; /* Optional aesthetic */
            padding-right: 0;
        }

        /* Signature Pad Styles */
        .signature-pad-container {
            margin-top: 15px;
        }

        .signature-pad-wrapper {
            position: relative;
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #fff;
            overflow: hidden;
        }

        .signature-pad {
            width: 100%;
            height: 150px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-pad-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 1rem;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .signature-pad-wrapper.has-signature .signature-pad-label {
            opacity: 0;
        }

        .signature-actions {
            margin-top: 8px;
            display: flex;
            gap: 10px;
        }

        .btn-clear-signature {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-clear-signature:hover {
            background-color: #c82333;
        }

        .signature-line {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            border-bottom: 1px dashed #ccc;
            pointer-events: none;
        }

        .btn-submit {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 60px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            transition: 0.3s;
        }
        
        .btn-submit:hover {
            background-color: #08337a;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Freq Flyer Input */
        .freq-flyer-input {
            display: none;
            margin-top: 4px;
        }

        /* Error Message Styles */
        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .error-message.show {
            display: block;
        }

        .error-message i {
            margin-left: 5px;
        }

        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        .form-control.is-invalid:focus,
        .form-select.is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Error Alert Box */
        .validation-alert {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .validation-alert.show {
            display: block;
        }

        .validation-alert h5 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }

        .validation-alert h5 i {
            margin-left: 10px;
        }

        .validation-alert ul {
            margin: 0;
            padding-right: 20px;
        }

        .validation-alert li {
            margin-bottom: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            /* Make paper container more mobile-friendly */
            .paper-container {
                padding: 20px 15px;
                margin: 15px auto;
            }

            /* Adjust section titles */
            .section-title {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="paper-container">
        
        <!-- Header -->
        <div class="text-center">
            <img src="sitelogo.png" alt="אידיאל טורס" class="img-fluid mb-3" style="max-height: 100px;">
            <div class="contact-highlight mb-3">
                נא להחזיר טופס זה בצירוף צילומי דרכונים לווצאפ 058-5396011 או לדוא"ל goski@idealtours.co.il
            </div>
            <h3>טופס הרשמה לחופשת סקי חורף 2025-2026</h3>
            <h4 class="text-primary mt-2">מלון MY KOSHER HOTEL 4****</h4>
        </div>

        <div class="row justify-content-center mt-4">
            <div class="col-md-4 text-center">
                <label class="form-label fw-bold">תאריך יציאה מבוקש:</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    <select class="form-select" id="vacationDateSelect" required>
                        <option value="">טוען תאריכים...</option>
                    </select>
                </div>
                <div class="error-message"><i class="fas fa-exclamation-circle"></i> יש לבחור תאריך יציאה</div>
            </div>
        </div>

        <form id="skiForm" onsubmit="submitForm(event)" novalidate>
            
            <!-- Validation Alert -->
            <div id="validationAlert" class="validation-alert">
                <h5><i class="fas fa-exclamation-triangle"></i> נא לתקן את השגיאות הבאות:</h5>
                <ul id="validationErrors"></ul>
            </div>
            
            <!-- Passengers -->
            <div class="section-title"><i class="fas fa-users"></i> פרטי הנוסעים והלן (באנגלית לפי הדרכון)</div>
            
            <div id="passengersContainer">
                <!-- JS creates passenger cards here -->
            </div>
            
            <button type="button" class="btn btn-sm btn-success rounded-pill px-3" onclick="addPassengerRow()">
                <i class="fas fa-plus"></i> הוסף נוסע
            </button>
            <div class="text-danger small mt-2 fw-bold">* שימו לב! תוקף הדרכון חייב להיות מינימום 3 חודשים מיום שובכם לארץ.</div>

            <!-- Documents Upload -->
            <div class="section-title"><i class="fas fa-cloud-upload-alt"></i> צרוף צילומי דרכונים</div>
            
            <div class="upload-area" id="dropZone">
                <i class="fas fa-passport fa-3x text-secondary mb-3"></i>
                <h5>גרור קבצים לכאן או לחץ לבחירה</h5>
                <p class="text-muted small mb-0">ניתן להעלות תמונות או קבצי PDF</p>
                <input type="file" id="fileInput" multiple class="d-none" onchange="handleFiles(this.files)">
            </div>
            <div id="fileListDisplay" class="mt-2"></div>

            <!-- Accommodation -->
            <div class="section-title"><i class="fas fa-bed"></i> סוג חדר ושיעורים</div>
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="fw-bold mb-2">בחירת סוג חדר:</label>
                    <div class="card p-3 bg-light border-0">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="roomType" id="roomStandard" value="standard" checked>
                            <label class="form-check-label" for="roomStandard">חדר סטנדרט</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="roomType" id="roomDeluxe" value="deluxe">
                            <label class="form-check-label" for="roomDeluxe">חדר דלוקס (נוף + תוספת תשלום)</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="fw-bold mb-2">הדרכת סקי:</label>
                    <div class="card p-3 bg-light border-0">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="lessonGroup">
                            <label class="form-check-label" for="lessonGroup">מעוניין להשתלב בביה"ס המקומי (בתשלום)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="lessonPrivate">
                            <label class="form-check-label" for="lessonPrivate">מעוניין בהדרכה פרטית (בתשלום)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact & Payment Details (From Bottom of PDF) -->
            <div class="section-title"><i class="fas fa-address-card"></i> פרטי המזמין ואמצעי תשלום</div>
            
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">כתובת מלאה (רחוב, עיר, מיקוד)</label>
                    <input type="text" class="form-control" name="address" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">טלפון נייד</label>
                    <input type="tel" class="form-control" name="phone" placeholder="05x-xxxxxxx" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">כתובת דוא"ל</label>
                    <input type="email" class="form-control" name="email" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">הערות ובקשות מיוחדות</label>
                    <input type="text" class="form-control" name="notes">
                </div>
            </div>

            <div class="bg-light p-3 rounded mt-3 border">
                <div class="row g-3">
                    <div class="col-12 fw-bold text-primary"><i class="far fa-credit-card"></i> פרטי אשראי לביטחון / תשלום:</div>
                    <div class="col-md-5">
                        <input type="text" class="form-control" name="cardNumber" placeholder="מספר כרטיס אשראי">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="cardType">
                            <option value="ויזה">ויזה</option>
                            <option value="מאסטרקארד">מאסטרקארד</option>
                            <option value="אמריקן אקספרס">אמריקן אקספרס</option>
                            <option value="דיינרס">דיינרס</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control text-center" name="cardExpiry" placeholder="תוקף (MM/YY)">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control text-center" name="cardCvv" placeholder="CVV">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="cardHolderId" placeholder="ת.ז בעל הכרטיס">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="cardHolderName" placeholder="שם בעל הכרטיס">
                    </div>
                </div>
            </div>

            <!-- Full Terms Text -->
            <div class="terms-box">
                <h6>תשלומים:</h6>
                עם ההרשמה יש להעביר מקדמה ע"ס 500€ לנוסע. (תוספת 1.5% לכרטיס אשראי אמריקן אקספרס ודיינרס) או בהעברה בנקאית לחשבון בבנק מזרחי, סניף גאולה, ירושלים מס' הסניף 417 מס' חשבון 116600 על שם אידיאל טורס בע"מ. במידה ונעשתה העברה בנקאית חשוב מאוד לשלוח לנו העתק של טופס ההעברה לכתובת דוא"ל או לווטסאפ כמופיע בראש עמוד זה. את יתרת התשלום יש לשלם 25 יום לפני היציאה. אי תשלום במועד הנקוב - משמעותו ביטול העסקה מצד הלקוח וכפוף לדמי הביטול כמפורט באתר.
                
                <h6>ביטולים:</h6>
                ביטול כלשהו יתקבל בכתב בלבד במייל או בווטסאפ. בביטול עד 30 יום לפני תאריך היציאה התשלום יוחזר, למעט 150€ דמי טיפול לאדם. במידה והטיסה הינה Lowcost המקדמה לא תוחזר. פחות מ 30 יום לפני מועד היציאה - דמי הביטול כמפורט באתר האינטרנט של אידיאל טורס: https://www.idealtours.co.il . אי תשלום במועד הנקוב - משמעותו ביטול העסקה מצד הלקוח, וכפוף לדמי הביטול.

                <h6>תנאים ואחריות:</h6>
                תאריכי יציאה קבוצתיים מותנים במינימום 30 נרשמים. זמני הטיסות ותנאיהן עשויים להשתנות, והם באחריותן הבלעדית של חברות התעופה ואינם באחריותה של אידיאל טורס. המחירים כפופים לשערי החליפין בין היורו לדולר וכפופים למחירי חברות התעופה. המחיר כולל: טיסות, העברות, 7 לילות בבית מלון על בסיס חצי פנסיון, סנדוויצ'ים בהכנה עצמית לצהריים, קפה ועוגה אחרי הצהריים, שבת - פנסיון מלא, סקי פס מורחב 57 ק"מ, כניסה חופשית בריכה ולספא, WIFI. המחיר אינו כולל מס מקומי. מס מקומי ישולם בקבלה במלון. טל"ח.
                
                <h6>חובה לרכוש ביטוח:</h6>
                בריאות, סקי, מטען וקורונה. ניתן לבצע דרך המשרד.
            </div>

            <!-- Confirmation & Signature -->
            <div class="mt-4">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="termsConfirm" required>
                    <label class="form-check-label fw-bold" for="termsConfirm">
                        קראתי את התנאים ואני מאשר אותם בחתימתי.
                    </label>
                </div>

                <div class="row align-items-end">
                    <div class="col-md-7">
                        <label class="form-label">חתימה:</label>
                        <div class="signature-pad-container">
                            <div class="signature-pad-wrapper" id="signaturePadWrapper">
                                <canvas id="signaturePad" class="signature-pad"></canvas>
                                <span class="signature-pad-label">חתום כאן</span>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-actions">
                                <button type="button" class="btn-clear-signature" onclick="clearSignature()">
                                    <i class="fas fa-eraser"></i> נקה חתימה
                                </button>
                            </div>
                        </div>
                        <!-- Hidden input to store signature data -->
                        <input type="hidden" id="signatureData" name="signatureData">
                    </div>
                    <div class="col-md-5 text-start">
                        תאריך: <span id="currentDate" class="fw-bold text-decoration-underline"></span>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <button type="submit" class="btn btn-submit shadow">
                    שליחת טופס <i class="fas fa-paper-plane ms-2"></i>
                </button>
            </div>

        </form>

        <div class="text-center mt-4 text-muted small">
            משרד: מלכי ישראל 53, ירושלים | טל: 02-5000821 | goski@idealtours.co.il
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbyqn2I4Q7P4Z_1k_qUVNQhc3aD6Cl1VYZ6DAEsZg3mBfK1_iGLO4X4zGIJphv9qz-Ll/exec';

    // --- Vacation Dates Logic ---
    async function loadVacationDates() {
        const select = document.getElementById('vacationDateSelect');
        try {
            const response = await fetch(`${BASE_URL}?action=getVacationDates`);
            
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            
            const dates = await response.json();
            
            select.innerHTML = '<option value="">בחר תאריך...</option>';
            
            if (Array.isArray(dates) && dates.length > 0) {
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">אין תאריכים זמינים</option>';
            }
        } catch (error) {
            console.error('Error loading vacation dates:', error);
            select.innerHTML = '<option value="">שגיאה בטעינת תאריכים</option>';
        }
    }

    // --- Passenger Logic ---
    let passengers = [1]; // Tracks existing row IDs

    function initTable() {
        addPassengerRow(); // Add the first row on load
        // Set Date
        const d = new Date();
        document.getElementById('currentDate').innerText = d.getDate() + '/' + (d.getMonth()+1) + '/' + d.getFullYear();
    }

    function addPassengerRow() {
        const container = document.getElementById('passengersContainer');
        const rowId = new Date().getTime(); // Unique ID
        const index = container.children.length + 1;

        const card = document.createElement('div');
        card.className = 'passenger-card';
        card.id = 'row-' + rowId;
        card.innerHTML = `
            <div class="passenger-card-header">
                <span class="passenger-number row-index">נוסע ${index}</span>
                <button type="button" class="btn-remove" onclick="removeRow('${rowId}')">
                    <i class="fas fa-trash-alt"></i> מחק
                </button>
            </div>
            <div class="passenger-fields">
                <div class="passenger-field">
                    <label>שם משפחה (לועזי)</label>
                    <input type="text" class="form-control" name="lastName_${rowId}" placeholder="LAST NAME" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="passenger-field">
                    <label>שם פרטי (לועזי)</label>
                    <input type="text" class="form-control" name="firstName_${rowId}" placeholder="FIRST NAME" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="passenger-field">
                    <label>תאריך לידה</label>
                    <input type="date" class="form-control" name="birthDate_${rowId}" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="passenger-field">
                    <label>מס' דרכון</label>
                    <input type="text" class="form-control" name="passportNumber_${rowId}" placeholder="מספר דרכון" required>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> שדה חובה</div>
                </div>
                <div class="passenger-field">
                    <label>נוסע מתמיד?</label>
                    <div class="freq-flyer-wrapper">
                        <div class="freq-row">
                            <input type="checkbox" class="form-check-input" name="hasFreqFlyer_${rowId}" onchange="toggleFreq(this)">
                            <span>כן, יש לי מספר</span>
                        </div>
                        <input type="text" class="form-control freq-flyer-input" name="freqFlyerNumber_${rowId}" placeholder="מס' נוסע מתמיד" style="display: none;">
                    </div>
                </div>
                <div class="passenger-field checkbox-field">
                    <input type="checkbox" class="form-check-input" name="skiPass_${rowId}" checked>
                    <label>סקי פס?</label>
                </div>
                <div class="passenger-field">
                    <label>רמת סקי</label>
                    <select class="form-select" name="skiLevel_${rowId}" required>
                        <option value="">בחר...</option>
                        <option value="4">4-מתקדם</option>
                        <option value="3">3-בינוני</option>
                        <option value="2">2-מתחיל+</option>
                        <option value="1">1-מתחיל</option>
                        <option value="SB">סנובורד</option>
                    </select>
                    <div class="error-message"><i class="fas fa-exclamation-circle"></i> יש לבחור רמת סקי</div>
                </div>
            </div>
        `;
        container.appendChild(card);
        updateRemoveButtons();
    }

    function removeRow(id) {
        const row = document.getElementById('row-' + id);
        if (row) {
            row.remove();
            reIndexRows();
            updateRemoveButtons();
        }
    }

    function reIndexRows() {
        const cards = document.querySelectorAll('#passengersContainer .passenger-card');
        cards.forEach((card, index) => {
            card.querySelector('.row-index').innerText = 'נוסע ' + (index + 1);
        });
    }

    function updateRemoveButtons() {
        const buttons = document.querySelectorAll('.btn-remove');
        const isSingle = buttons.length === 1;
        
        buttons.forEach(btn => {
            btn.disabled = isSingle;
        });
    }

    function toggleFreq(checkbox) {
        const wrapper = checkbox.closest('.freq-flyer-wrapper');
        const input = wrapper.querySelector('.freq-flyer-input');
        input.style.display = checkbox.checked ? 'block' : 'none';
        if(checkbox.checked) input.focus();
    }

    // --- File Upload Logic ---
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileListDisplay = document.getElementById('fileListDisplay');
    let uploadedFiles = []; // To store file objects

    // Click to upload
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag & Drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    function handleFiles(files) {
        // Convert FileList to Array and add to our list
        for (let i = 0; i < files.length; i++) {
            uploadedFiles.push(files[i]);
        }
        renderFileList();
    }

    function renderFileList() {
        fileListDisplay.innerHTML = '';
        uploadedFiles.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'file-list-item';
            div.innerHTML = `
                <span><i class="far fa-file-alt text-primary me-2"></i> ${file.name}</span>
                <i class="fas fa-times text-danger" style="cursor:pointer" onclick="removeFile(${index})"></i>
            `;
            fileListDisplay.appendChild(div);
        });
    }

    function removeFile(index) {
        // In a real form, you'd need to manipulate the DataTransfer object to sync with input, 
        // but for UI demo we just update the array
        uploadedFiles.splice(index, 1);
        renderFileList();
    }

    // --- Validation Functions ---
    function clearAllErrors() {
        // Clear validation alert
        const validationAlert = document.getElementById('validationAlert');
        validationAlert.classList.remove('show');
        document.getElementById('validationErrors').innerHTML = '';
        
        // Clear all inline error messages
        document.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('show');
        });
        
        // Remove invalid class from all inputs
        document.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
    }

    function showFieldError(inputElement, message) {
        inputElement.classList.add('is-invalid');
        // Try to find error message in parent or sibling elements
        let errorDiv = inputElement.parentElement.querySelector('.error-message');
        if (!errorDiv) {
            // Try grandparent (for input-group structure)
            errorDiv = inputElement.closest('.col-md-4, .col-md-6, .col-md-8, .passenger-field, [class*="col-"]')?.querySelector('.error-message');
        }
        if (errorDiv) {
            if (message) {
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            }
            errorDiv.classList.add('show');
        }
    }

    function showValidationAlert(errors) {
        const validationAlert = document.getElementById('validationAlert');
        const errorsList = document.getElementById('validationErrors');
        
        errorsList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
        validationAlert.classList.add('show');
        
        // Scroll to the alert
        validationAlert.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function validateForm() {
        clearAllErrors();
        const errors = [];
        let firstInvalidElement = null;

        // 1. Validate vacation date
        const vacationDateSelect = document.getElementById('vacationDateSelect');
        if (!vacationDateSelect.value) {
            showFieldError(vacationDateSelect, 'יש לבחור תאריך יציאה');
            errors.push('יש לבחור תאריך יציאה');
            if (!firstInvalidElement) firstInvalidElement = vacationDateSelect;
        }

        // 2. Validate passengers
        const passengerCards = document.querySelectorAll('.passenger-card');
        passengerCards.forEach((card, index) => {
            const passengerNum = index + 1;
            
            // Check required inputs in passenger card
            const inputs = card.querySelectorAll('input[required], select[required]');
            inputs.forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    showFieldError(input);
                    const label = input.closest('.passenger-field').querySelector('label');
                    const fieldName = label ? label.textContent : 'שדה';
                    errors.push(`נוסע ${passengerNum}: ${fieldName} - שדה חובה`);
                    if (!firstInvalidElement) firstInvalidElement = input;
                }
            });
        });

        // 3. Validate contact info
        const addressInput = document.querySelector('input[name="address"]');
        const phoneInput = document.querySelector('input[name="phone"]');
        const emailInput = document.querySelector('input[name="email"]');

        if (!addressInput.value.trim()) {
            showFieldError(addressInput, 'יש למלא כתובת מלאה');
            errors.push('יש למלא כתובת מלאה');
            if (!firstInvalidElement) firstInvalidElement = addressInput;
        }

        if (!phoneInput.value.trim()) {
            showFieldError(phoneInput, 'יש למלא מספר טלפון');
            errors.push('יש למלא מספר טלפון');
            if (!firstInvalidElement) firstInvalidElement = phoneInput;
        } else if (!isValidPhoneNumber(phoneInput.value)) {
            showFieldError(phoneInput, 'מספר טלפון לא תקין');
            errors.push('מספר טלפון לא תקין');
            if (!firstInvalidElement) firstInvalidElement = phoneInput;
        }

        if (!emailInput.value.trim()) {
            showFieldError(emailInput, 'יש למלא כתובת דוא"ל');
            errors.push('יש למלא כתובת דוא"ל');
            if (!firstInvalidElement) firstInvalidElement = emailInput;
        } else if (!isValidEmail(emailInput.value)) {
            showFieldError(emailInput, 'כתובת דוא"ל לא תקינה');
            errors.push('כתובת דוא"ל לא תקינה');
            if (!firstInvalidElement) firstInvalidElement = emailInput;
        }

        // 4. Validate terms acceptance
        const termsConfirm = document.getElementById('termsConfirm');
        if (!termsConfirm.checked) {
            errors.push('יש לאשר את התנאים');
            if (!firstInvalidElement) firstInvalidElement = termsConfirm;
        }

        // 5. Validate signature
        if (isSignatureEmpty()) {
            errors.push('יש לחתום על הטופס');
        }

        return { isValid: errors.length === 0, errors, firstInvalidElement };
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function isValidPhoneNumber(phone) {
        // Allow Israeli phone formats: 05X-XXXXXXX, 05XXXXXXXX, 0X-XXXXXXX
        const phoneRegex = /^0\d{1,2}[-]?\d{7}$/;
        return phoneRegex.test(phone.replace(/\s/g, ''));
    }

    // --- Submit ---
    function submitForm(e) {
        e.preventDefault();
        
        // Validate all fields
        const validation = validateForm();
        
        if (!validation.isValid) {
            showValidationAlert(validation.errors);
            
            // Focus on first invalid element
            if (validation.firstInvalidElement) {
                validation.firstInvalidElement.focus();
            }
            return;
        }
        
        // Save the signature data before submitting
        saveSignature();
        
        // Collect form data for API submission
        const formData = collectFormData();
        
        // For now, just show success
        alert('הטופס נשלח בהצלחה למערכת!');
        console.log('Form data:', formData);
    }

    // --- Collect Form Data for API ---
    function collectFormData() {
        const data = {
            vacationDate: document.getElementById('vacationDateSelect').value,
            passengers: [],
            files: [],
            roomType: document.querySelector('input[name="roomType"]:checked').value,
            skiLessons: {
                groupLesson: document.getElementById('lessonGroup').checked,
                privateLesson: document.getElementById('lessonPrivate').checked
            },
            contactInfo: {
                address: document.querySelector('input[name="address"]').value,
                phone: document.querySelector('input[name="phone"]').value,
                email: document.querySelector('input[name="email"]').value,
                notes: document.querySelector('input[name="notes"]').value || null
            },
            payment: {
                cardNumber: document.querySelector('input[name="cardNumber"]').value || null,
                cardType: document.querySelector('select[name="cardType"]').value,
                expiryDate: document.querySelector('input[name="cardExpiry"]').value || null,
                cvv: document.querySelector('input[name="cardCvv"]').value || null,
                cardHolderId: document.querySelector('input[name="cardHolderId"]').value || null,
                cardHolderName: document.querySelector('input[name="cardHolderName"]').value || null
            },
            termsAccepted: document.getElementById('termsConfirm').checked,
            signature: document.getElementById('signatureData').value,
            submissionDate: document.getElementById('currentDate').innerText
        };

        // Collect passenger data
        const passengerCards = document.querySelectorAll('.passenger-card');
        passengerCards.forEach(card => {
            const rowId = card.id.replace('row-', '');
            const passenger = {
                lastName: card.querySelector(`input[name="lastName_${rowId}"]`).value,
                firstName: card.querySelector(`input[name="firstName_${rowId}"]`).value,
                birthDate: card.querySelector(`input[name="birthDate_${rowId}"]`).value,
                passportNumber: card.querySelector(`input[name="passportNumber_${rowId}"]`).value,
                frequentFlyer: {
                    hasNumber: card.querySelector(`input[name="hasFreqFlyer_${rowId}"]`).checked,
                    number: card.querySelector(`input[name="freqFlyerNumber_${rowId}"]`).value || null
                },
                skiPass: card.querySelector(`input[name="skiPass_${rowId}"]`).checked,
                skiLevel: card.querySelector(`select[name="skiLevel_${rowId}"]`).value
            };
            data.passengers.push(passenger);
        });

        // Collect file data (as base64)
        // Note: In a real implementation, you would read files as base64
        uploadedFiles.forEach(file => {
            data.files.push({
                name: file.name,
                type: file.type,
                size: file.size
            });
        });

        return data;
    }

    // --- Signature Pad Logic ---
    let signaturePad;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    function initSignaturePad() {
        const canvas = document.getElementById('signaturePad');
        const wrapper = document.getElementById('signaturePadWrapper');
        
        if (!canvas) return;
        
        signaturePad = canvas.getContext('2d');
        
        // Set canvas size to match container
        resizeCanvas();
        
        // Set drawing styles
        signaturePad.strokeStyle = '#000';
        signaturePad.lineWidth = 2;
        signaturePad.lineCap = 'round';
        signaturePad.lineJoin = 'round';
        
        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);
        
        // Handle window resize
        window.addEventListener('resize', resizeCanvas);
    }
    
    function resizeCanvas() {
        const canvas = document.getElementById('signaturePad');
        const wrapper = document.getElementById('signaturePadWrapper');
        
        if (!canvas || !wrapper) return;
        
        const hadSignature = wrapper.classList.contains('has-signature');
        
        // Only save signature data if there's actually a signature
        let dataUrl = null;
        if (hadSignature) {
            dataUrl = canvas.toDataURL();
        }
        
        // Resize canvas
        const rect = wrapper.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = 150;
        
        // Restore drawing styles after resize (canvas reset clears styles)
        signaturePad.strokeStyle = '#000';
        signaturePad.lineWidth = 2;
        signaturePad.lineCap = 'round';
        signaturePad.lineJoin = 'round';
        
        // Restore signature if there was one
        if (hadSignature && dataUrl) {
            const img = new Image();
            img.onload = function() {
                signaturePad.drawImage(img, 0, 0);
            };
            img.src = dataUrl;
        }
    }
    
    function getPointerPos(e) {
        const canvas = document.getElementById('signaturePad');
        const rect = canvas.getBoundingClientRect();
        
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    function startDrawing(e) {
        isDrawing = true;
        const pos = getPointerPos(e);
        lastX = pos.x;
        lastY = pos.y;
        
        // Mark that we have a signature
        document.getElementById('signaturePadWrapper').classList.add('has-signature');
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        const pos = getPointerPos(e);
        
        signaturePad.beginPath();
        signaturePad.moveTo(lastX, lastY);
        signaturePad.lineTo(pos.x, pos.y);
        signaturePad.stroke();
        
        lastX = pos.x;
        lastY = pos.y;
    }
    
    function stopDrawing() {
        if (isDrawing) {
            isDrawing = false;
            // Save signature data when user stops drawing
            saveSignature();
        }
    }
    
    function getTouchPos(e) {
        const canvas = document.getElementById('signaturePad');
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        
        return {
            x: touch.clientX - rect.left,
            y: touch.clientY - rect.top
        };
    }
    
    function handleTouchStart(e) {
        e.preventDefault();
        isDrawing = true;
        const pos = getTouchPos(e);
        lastX = pos.x;
        lastY = pos.y;
        
        // Mark that we have a signature
        document.getElementById('signaturePadWrapper').classList.add('has-signature');
    }
    
    function handleTouchMove(e) {
        if (!isDrawing) return;
        e.preventDefault();
        
        const pos = getTouchPos(e);
        
        signaturePad.beginPath();
        signaturePad.moveTo(lastX, lastY);
        signaturePad.lineTo(pos.x, pos.y);
        signaturePad.stroke();
        
        lastX = pos.x;
        lastY = pos.y;
    }
    
    function clearSignature() {
        const canvas = document.getElementById('signaturePad');
        const wrapper = document.getElementById('signaturePadWrapper');
        
        if (!canvas || !signaturePad) return;
        
        signaturePad.clearRect(0, 0, canvas.width, canvas.height);
        wrapper.classList.remove('has-signature');
        document.getElementById('signatureData').value = '';
    }
    
    function saveSignature() {
        const canvas = document.getElementById('signaturePad');
        if (!canvas) return;
        
        // Get signature as PNG data URL
        const signatureDataUrl = canvas.toDataURL('image/png');
        document.getElementById('signatureData').value = signatureDataUrl;
    }
    
    function isSignatureEmpty() {
        const wrapper = document.getElementById('signaturePadWrapper');
        return !wrapper || !wrapper.classList.contains('has-signature');
    }
    
    /**
     * Public API function to retrieve the signature as a base64 PNG image.
     * Can be used by external scripts or form handlers to get the signature data.
     * @returns {string} Base64 encoded PNG data URL of the signature
     */
    function getSignatureAsImage() {
        return document.getElementById('signatureData').value;
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
        initTable();
        initSignaturePad();
        loadVacationDates();
    });

</script>

</body>
</html>